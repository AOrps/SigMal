# Week 09
## TOR
Before getting started with what TOR is and how it works, go ahead and download TOR for some demos later.\
In Windows, you can go [here](https://www.torproject.org/download/) to get an installer.\
You can use the same link to find download information for Mac, Linux, and Android, but on Linux (Debian), it is easier to simply download via the terminal. You can also use the bash script in /demo/sem3-09.\
```bash
# Make sure you have the Universe repo added, which you should as it is fairly standard
# but just in case you don't:
sudo add-apt-repository universe
sudo apt update

sudo apt install torbrowser-launcher
```
And that is that!

##### Slight Digression into OS Selection
For the more paranoid, there also exist things like [Tails](https://tails.boum.org/), [Qubes OS](https://www.qubes-os.org/), and [Whonix](https://www.whonix.org/). Qubes OS is intense in that it runs *every single application* in dedicated virtual machines, it uses multiple different OS' at the same time, Whonix is built in, etc etc etc. Word of warning though, you need to have a better computer than mine to run this with any semblance of real-time control. There are actual recommendations for specific hardware that has proper security features. There are even [certified Qubes laptops](https://www.qubes-os.org/doc/certified-hardware/).\
Whonix is a very basic operating system *designed* to run within other OS' in a VM or even off a USB.

Lastly, Tails is quite nice. It is designed to be installed onto and run off of a USB. It has amnesia, meaning it does not have any sort of persistent storage (unless you specifically set some up) and everything effectively gets wiped on shutdown. No downloaded files are saved, WiFi networks are forgotten, etc etc etc. Tails does not (and frankly, cannot unless you do some setup) touch any other drive on the computer - it is limited entirely to the USB it is running off of. If you do want to have some kind of persistent storage, say remember certain WiFi networks and their passwords, or maybe a specific application, you can configure certain persistent storage for certain things to be not-deleted when powered-down. All persistent storage is also encrypted.\
Out of the box, Tails *only* comes with TOR and some nifty TOR-related utilities (TorCircuits is fun to look at).\
I often carry around an installation of Tails on a small 8gb USB for using public computers and what not.

##### Further digression because I can't help myself
[![when shuttles blow up, it's not always an accident](https://static.wikia.nocookie.net/familyguy/images/c/c8/Painting_the_walls.png/revision/latest/scale-to-width-down/340?cb=20200427193240)](https://youtu.be/uk7bZ9RjzYE)\
If you are paranoid about your ISP looking at what you're doing, well, they can't necessarily see what you are doing as your communications are, or should be, encrypted, *but* your ISP can get an idea of what you are doing by seeing where you are sending messages. Even if you use something like Tor or a VPN to block that out, you you *may* want to reconfigure your DNS server anyways - just to be safe. By default, your DNS server is likely set up to default to whatever DNS server your ISP has set up, and if you are like me, your ISP has a lousy router that sucks and does not let you change the DNS server to be whatever you want. In this case, you can change your DNS settings on your device. There is usually an option in a settings menu somewhere.\
In Linux, to ensure your computer *only* uses the specific DNS servers you want, you can do a quick:
```bash
sudo nano /etc/resolv.conf
```
Add your own DNS server IPs by inserting `nameserver <insert-ip>`, for example, here is mine:
```bash
cat /etc/resolv.conf
nameserver 1.1.1.1
nameserver 1.0.0.1
# IPv6 stuff
2606:4700:4700::1111
2606:4700:4700::1001
```
You can further check what your DNS server is by using the `dig` command.
[1.1.1.1](1.1.1.1) is Cloudflare's DNS service (1.0.0.1 is their backup). Google also has one (8.8.8.8), Cisco has OpenDNS (not-memorable-ip), Quad9 is at 9.9.9.9, Amazon has Route 53, etc etc etc. There are of course other DNS providers out there that provide a more premium and secure service for users who want that *extra* security.

### What is TOR
TOR stands for "The Onion Router", which begs the question; what is "onion routing"?\
The concept of onion routing was developed by the US Naval Research Laboratory in the mid '90s for the purpose of protecting US communications.\
In 2002, Paul Syverson, Roger Dingledine and Nick Mathewson began working on their implementation of onion routing, now called "The Onion Routing project", that would eventually become what we know as TOR.

### How does it work?
Let us assume that everyone reading this knows how Public/Private key encryption works.\
Let us assume the following scenario: Jameson wants to send a message to his friend Metaxa.\
Jameson knows all of the information needed to send a packet to Metaxa, and so he packs up all of that information and sends it out where it bounces from router to router until it ends up at Metaxa's computer - job jobbed.\
Now what if Jameson did not want anyone knowing he was talking with Metaxa - say Jameson's other friend Sake does not want Jameson speaking with Metaxa because Metaxa said she didn't like Sake's choice of shirt that one time and it became a whole thing. Jameson and Metaxa go way back though, so he can't just stop talking to her.\
If Jameson sends messages to Metaxa in the normal way, Sake would simply be able to see the packets being sent out and read the packet headers that would clearly say "from Jameson to Metaxa" - this will not do.\
Thankfully, Jameson has TOR installed and uses it to keep talking with Metaxa. Let us now follow what happens when he sends his messages to Metaxa.\
First, Jameson (or rather his computer) picks out three specific routers that he will use to send his message to Metaxa. Let us call these routers A, B, and C. These routers, called nodes or relays, have been set up to be TOR routers and these are the routers Jameson will bounce his message though.
```
                         World of Routers

+---------+        +-----+    +-----+    +-----+
| Jameson | +--->  |  A  |    |     |    |     |
+---------+        +-----+    +-----+    +-----+
                           \
                   +-----+  \ +-----+    +-----+       +--------+
                   |     |    |  B  | -- |  C  | +---> | Metaxa |
                   +-----+    +-----+    +-----+       +--------+

                   +-----+    +-----+    +-----+
                   |     |    |     |    |     |
                   +-----+    +-----+    +-----+
```
This is all well and good, but whatever packet headers are needed to carry this out can still be picked up and read - Sake has a lot of time on her hands and is good with Wireshark. To add some encryption, Jameson then does a quick key-exchange with each router. K1 decrypts a message from Jameson to A, K2 decrypts a message from Jameson to B, and K3 decrypts a message from Jameson to C.\
Visualized:
```
Original message with headers - this would normally be unencrypted
+---------------+
|message|from to|
+---------------+

First, the message is encrypted with K3 - meaning only C can
decrypt the message to see what the actual headers are and where
the final destination is.
+-------------------+---------+
| +---------------+ |         |
| |message|from to| |from to C|
| +---------------+ |         |
+-------------------+---------+

Next, this entire packet is further encrypted with K2.
+---------------------------------+---------+
| +-----------------------------+ |         |
| | +---------------+ |         | |         |
| | |message|from to| |from to C| |from to B|
| | +---------------+ |         | |         |
| +-----------------------------+ |         |
+---------------------------------+---------+

And finally, this entire packet is encrypted with K1.
+-----------------------------------------------+---------+
| +-------------------------------------------+ |         |
| | +-----------------------------+ |         | |         |
| | | +---------------+ |         | |         | |         |
| | | |message|from to| |from to C| |from to B| |from to A|
| | | +---------------+ |         | |         | |         |
| | +-----------------------------+ |         | |         |
| +-------------------------------------------+ |         |
+-----------------------------------------------+---------+
```
This process is where the term "onion" comes from.\
So, referencing the diagram from before, from Jameson to A, all anyone can see is that there is a packet coming from Jameson meant to be going to A - the payload of the packet is absolute nonsense because nobody looking in knows the key to decrypt it. Once the packet arrives at A, A decrypts the packet using K1, and then sends this off to B. If anyone tries to read this packet now, all they can see is that it is coming from A and meant to be going to B, and again the payload is nonsense because it is still encrypted with K2 and K3. Once it arrives at B, B again strips off another layer of encryption using K2 and passes the packet off to C. All anyone intercepting the packet at this point would see is that there is a packet coming from B going to C, and the payload is of course nonsense. When the packet arrives at C, C strips off the last layer of encryption, looks at the bare packet, reads the headers, sees where the packet should be sent off to, and passes it on in the normal way.\
If Sake was set up intercepting packets just before the enter Metaxa's house, all she would see is that a message coming from C was sent to Metaxa - she has no idea where that message came from before that.\
If Metaxa wanted to send a response back, she sends a message back to C, C looks at the message and sees "ok, this is coming from Metaxa going to Jameson, and Jameson sent a message to Metaxa before, this message should also be encrypted - I shall encrypt it with K3 and send it back the way it came to B", so response gets encapsulated with additional layers of encryption all the way back to Jameson who can then decrypt everything as he has K1, K2, and K3.\
Job done! Jameson can keep sending his messages without them being traced back to him!*
\* Messages may end up being traced back to him

#### More Technical Details
A, B, and C in the above example form what is called a "Tor circuit". Tor uses 3 nodes per circuit. You could in theory use 5, 7, 20, 40, etc nodes in a circuit if you wanted to, and have the message bounce all the way around the world a good 3 or 4 times like in those old hacker movies, but the time delay would be *astounding*. You may as well set up your own covert spy-ring passing letters written in invisible ink around the world until they reach your destination and then do the whole thing in reverse just to hand you a printout of the HTML webpage you were trying to view and it would probably be faster. Point is, past 3 nodes, you don't see much improvement in terms of security but you you *do* see very long delays.\
[TorFlow](https://torflow.uncharted.software/) has a nice little visualization to see where Tor Relays are.\
"How was Jameson able to find A, B, and C; you can't just pick 3 random computers out on the internet and try to use them as Tor nodes" you may ask. Well, Jameson picks out A, B, and C by asking someone for a Tor circuit, that someone being a directory server. A directory server has a list of all the available Tor nodes and what circuits they can be formed into. Jameson's computer will query a directory server for a circuit. It will respond with a circuit of 3 nodes that Jameson can then use. When Jameson sends a message to A (called an entry-node), part of the message header that A will be able to see is what circuit it is a part of, and therefore where it should forward the message to next. C, at the end of the chain, is the exit node, and when a message is sent to C to go right the way back to Jameson, C uses the same circuit to figure out it should be sending the message to B.\
This is quite clever - no node knows the full nature of the connection - they only know what comes before and what comes after.\
"But, surely someone would be able to look at the packet sizes to try and glean some information - maybe a small packet would signal that it is at the end of a longer communication or something". Thankfully, this has been accounted for. All packets (called cells) sent through the Tor network are 512 bytes - always. They are split up an padded accordingly so that nobody can glean any sort of information from the size of the packets. The way this is done is actually very clever. Each cell has a small hash appended to the end that a node can the look at. The node thenceforth uses that hash to hash the message. If the result does not match the hash the node was expecting, it figures that "clearly this message is not meant for me - it must be passed on".
"What if someone picks a node at random and just spams packets at it in a DoS attack?" Well, it shouldn't be too bad because Tor circuits are recreated every 10 minutes.\
"Ok, but what if someone runs an attack on that directory server, or if you are somehow barred fro querying that directory server by an admin or your government?" Well then you are absolutely stuffed and there is not much you can do about it. Well, there is but that is something for another time, but, I guess I should list some of the problems with Tor.

### Vulnerabilities
By far the biggest vulnerability here is that packets sent from the exit node to the final destination are sent very much in the open. If you were logging in to an http site, then the fact that you are using Tor is meaningless. Sure, someone may not be able to tell where the message originated from, but the connection to the destination is not encrypted, and if you are logging in to such a site, they could skim your user ID and see "yeah, So-and-so is visiting \<insert-website-you-wouldn't-want-people-knowing-you-visit> again". Tor does not protect you from your own stupidity - make sure you are visiting secure sites all the same.\
The second vulnerability is that traffic can be correlated.
```
                         World of Routers

+---------+        +-----+    +-----+    +-----+
| Jameson | +--->  |  A  |    |     |    |     |
+---------+   ^    +-----+    +-----+    +-----+
              ^            \
                   +-----+  \ +-----+    +-----+       +--------+
                   |     |    |  B  | -- |  C  | +---> | Metaxa |
                   +-----+    +-----+    +-----+   ^   +--------+
                                                   ^
                   +-----+    +-----+    +-----+
                   |     |    |     |    |     |
                   +-----+    +-----+    +-----+
```
If Sake were to sniff at these two points and sees Jameson send 5 packets, an then a few milliseconds later sees 5 packets go from C to Metaxa, it doesn't take a geninus to put 2 and 2 together and realize that maybe Jameson was sending packets to Metaxa. There is absolutely no counter to this. You just have to rely on the sheer volume of traffic coming from yourself and everyone else on the internet is chaotic enough to keep you obfuscated, but someone dedicated could begin to deanonymize you.\
Another concern is that there is nothing stopping certain people with access to lots of money and computers (i.e. governments and large companies) from setting up a tonne of Tor relays in the hopes that they end up controlling A and C in a circuit. This is also something you just have to live with. There are however *some* counters to this. A is often called the "guard node" because it guards who the message is coming from. If someone has control of A and C, then regardless of encryption you are deanonymized. For this reason there is a list of trusted guard nodes that you can select from instead of a truly random node.
There are more Vulnerabilities but I am no where near knowledgeable enough to understand them let alone describe them. You can read accounts of how the Silk Road was brought down and traced back to Ross Ulbricht. A lot of it seems to boil down to poor Opsec.\

### Routing Other Stuff through TOR
There are a few ways to do this. [Tortilla](https://github.com/CrowdStrike/Tortilla) is a FOS way to do this in Windows and [TorGhost](https://github.com/SusmithKrishnan/torghost) is a nice way to do it over Linux. This sort of thing is done by by redirecting whatever internet traffic you may have through the SOCKS5 tor proxy. You can do this in a sort of hands on way through certain applications that may allow for the configuration of a proxy. You would simply set the proxy server to be `localhost` or `127.0.0.1` and the port to `8118`. It is far easier to use something like TorGhost which also has some added features to try and keep you anonymous.

### Hidden Services
Hidden services are just normal websites. `expyuzz4wqqyqhjn.onion` is the Tor main website as a hidden service for example.\
First, just going to give a pair of links to some basic search services.\
[Ahmia](ahmia.fi): `msydqstlz2kzerdg.onion`\
torch: `torchdeedp3i2jigzjdmfpn5ttjhthh5wbmda2rr3jvqjg5p77c54dqd.onion`\
What makes these services "hidden" is that our dear friend Google can't turn up these results for a search.\
To address some conceptions: Yes, a lot of what goes on in the dark web here is illegal - *tread carefully*. No, not all of it is illegal - a lot of what goes on is also just normal stuff.\
There are hidden email services, social media platforms of sorts, even file sharing services. Whatever normal thing you can imagine people doing on the internet also goes on in the dark web.\

#### How Hidden Services Work
In the most basic sense, you can think of hidden services like meeting up with someone selling something online. You contact the seller, you then tell them that you want to meet and where, an then you both meet up.\
A very similar process occurs with a hidden service.\
First, a server hosting a hidden service picks some nodes at random to serve as introduction points (IP). These will serve as the first point of contact for someone wishing to get in touch with the server. In the online-purchase example, the IPs would be something like an online messaging board or posting.
```
                                        World of Routers
             +------------------------------------------------------------------+
             |                                                                  |
+-----+      |  +-----+    +-----+    +-----+    +-----+    +-----+    +-----+  |
| you |      |  |     |    |     |    | I P +<-+ |     +<+  |     |    |     |  |
+-----+      |  +-----+    +-----+    +-----+    +-----+ |  +-----+    +-----+  |
             |                                           +-----------+          |
             |  +-----+    +-----+    +-----+    +-----+    +-----+  | +-----+  |
             |  |     |    |     |    |     |    |     |    |     |  + |     | <---+
             |  +-----+    +-----+    +-----+    +-----+    +-----+    +-----+  |  |
             |                                                                  |  |
             |  +-----+    +-----+    +-----+    +-----+    +-----+    +-----+  |  |
             |  |     |    |     |    |     |    | I P +<-+ |     +<-+ |     |  |  |
             |  +-----+    +-----+    +-----+    +-----+    +-----+  | +-----+  |  |
             |                                                       |          |  |
             |  +-----+    +-----+    +-----+    +-----+    +-----+  | +-----+  |  |
             |  |     |    |     |    |     |    |     |    |     |  + |     | <---+
             |  +-----+    +-----+    +-----+    +-----+    +-----+    +-----+  |  |
             |                                                                  |  |
             |  +-----+    +-----+    +-----+    +-----+    +-----+    +-----+  |  |
             |  |     |    |     |    |     |  + |     +<+  |     |    |     |  |  |
             |  +-----+    +-----+    +-----+  | +-----+ |  +-----+    +-----+  |  |
             |                                 |         +-----------+          |  |
             |  +-----+    +-----+    +-----+  | +-----+    +-----+  | +-----+  |  |  +--------+
             |  |     |    | I P +<+  |     |  | |     |    |     |  + |     | <---+--+ server |
             |  +-----+    +-----+ |  +-----+  | +-----+    +-----+    +-----+  |     +--------+
             |                     +-----------+                                |
             +------------------------------------------------------------------+


```
When you wish to query the server you first go through the normal process of selecting 3 relays. The last node will *then* pass on the query to an IP so that the message may thenceforth be sent all the way back to the server.
```
                                      World of Routers
             +------------------------------------------------------------------+
             |                                                                  |
+-----+      |  +-----+    +-----+    +-----+    +-----+    +-----+    +-----+  |
| you +-------> |     | +  |     |    |     |    |     |    |     |    |     |  |
+-----+      |  +-----+ |  +-----+    +-----+    +-----+    +-----+    +-----+  |
             |          |                                                       |
             |  +-----+ |  +-----+    +-----+    +-----+    +-----+    +-----+  |
             |  |     | +> |     | +->+ R P | +  |     |    |     |    |     |  |
             |  +-----+    +-----+    +-----+ |  +-----+    +-----+    +-----+  |
             |                                |                                 |
             |  +-----+    +-----+    +-----+ |  +-----+    +-----+    +-----+  |
             |  |     |    |     |    |     | +->+ I P | +->+     | +  |     |  |
             |  +-----+    +-----+    +-----+    +-----+    +-----+ |  +-----+  |
             |                                                      |           |
             |  +-----+    +-----+    +-----+    +-----+    +-----+ |  +-----+  |
             |  |     |    |     |    |     |    |     |    |     | +->+     | +---+
             |  +-----+    +-----+    +-----+    +-----+    +-----+    +-----+  |  |
             |                                                                  |  |
             |  +-----+    +-----+    +-----+    +-----+    +-----+    +-----+  |  |
             |  |     |    |     |    |     |    |     |    |     |    |     |  |  |
             |  +-----+    +-----+    +-----+    +-----+    +-----+    +-----+  |  |
             |                                                                  |  |
             |  +-----+    +-----+    +-----+    +-----+    +-----+    +-----+  |  |  +--------+
             |  |     |    |     |    |     |    |     |    |     |    |     |  |  +->+ server |
             |  +-----+    +-----+    +-----+    +-----+    +-----+    +-----+  |     +--------+
             |                                                                  |
             +------------------------------------------------------------------+
```
In this way, your initial query makes it all the way to the server. The server, assuming it wants to serve you, will remember the rendezvous point (the last node in your 3-hop Tor circuit) and will establish a new tor circuit to that rendezvous point.
```
                                      World of Routers
             +------------------------------------------------------------------+
             |                                                                  |
+-----+      |  +-----+    +-----+    +-----+    +-----+    +-----+    +-----+  |
| you +-------> |     | +  |     |    |     |    |     |    |     |    |     |  |
+-----+      |  +-----+ |  +-----+    +-----+    +-----+    +-----+    +-----+  |
             |          |                                                       |
             |  +-----+ |  +-----+    +-----+    +-----+    +-----+    +-----+  |
             |  |     | +> |     | +->+ R P +<-+ |     |    |     |    |     |  |
             |  +-----+    +-----+    +-----+  | +-----+    +-----+    +-----+  |
             |                                 |                                |
             |  +-----+    +-----+    +-----+  | +-----+    +-----+    +-----+  |
             |  |     |    |     |    |     |  | |     |    |     |    |     |  |
             |  +-----+    +-----+    +-----+  | +-----+    +-----+    +-----+  |
             |                                 |                                |
             |  +-----+    +-----+    +-----+  | +-----+    +-----+    +-----+  |
             |  |     |    |     |    |     |  +-+     | <+ |     |    |     |  |
             |  +-----+    +-----+    +-----+    +-----+  | +-----+    +-----+  |
             |                                            |                     |
             |  +-----+    +-----+    +-----+    +-----+  | +-----+    +-----+  |
             |  |     |    |     |    |     |    |     |  + |     | <+ |     |  |
             |  +-----+    +-----+    +-----+    +-----+    +-----+  | +-----+  |
             |                                                       |          |
             |  +-----+    +-----+    +-----+    +-----+    +-----+  | +-----+  |     +--------+
             |  |     |    |     |    |     |    |     |    |     |  + |     |  <-----+ server |
             |  +-----+    +-----+    +-----+    +-----+    +-----+    +-----+  |     +--------+
             |                                                                  |
             +------------------------------------------------------------------+
```
Now what has happened is very very clever. You have successfully established a connection to a server where neither you nor the server know who each other is. Nobody listening in to this connection at any point is able to figure out who is communicating. Pretty damn cool.

### Sources and intersting reads
[Tor Documentation](https://2019.www.torproject.org/docs/documentation.html.en)
[Tor: Hidden Service Scaling](https://www.benthamsgaze.org/wp-content/uploads/2015/11/sucu-torscaling.pdf)
[Onion Routing on Wikipedia](https://en.wikipedia.org/wiki/Onion_routing)
Also, Computerphile has a nice video on Tor by Dr. Mike Pound (the absolute legend)
